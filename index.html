<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrevistador Virtual IA</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            background: #000000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .chat-container {
            background: linear-gradient(180deg, #1c1c1e 0%, #000000 100%);
            min-height: 100vh;
        }
        
        .message-bubble {
            max-width: 280px;
            word-wrap: break-word;
            animation: fadeInUp 0.3s ease-out;
        }
        
        .user-message {
            background: linear-gradient(135deg, #00FF88 0%, #00CC6A 100%);
            color: #000000;
            border-radius: 20px 20px 4px 20px;
            box-shadow: 0 2px 12px rgba(0, 255, 136, 0.3);
        }
        
        .ai-message {
            background: #2c2c2e;
            color: #ffffff;
            border-radius: 20px 20px 20px 4px;
            border-left: 3px solid #6B46C1;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
        }
        
        .typing-indicator {
            background: #2c2c2e;
            border-radius: 20px;
            padding: 12px 16px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            animation: pulse 1.5s infinite;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6B46C1;
            animation: typingDot 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        .input-container {
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(107, 70, 193, 0.2);
        }
        
        .message-input {
            background: #1c1c1e;
            border: 2px solid #3a3a3c;
            border-radius: 25px;
            color: #ffffff;
            transition: all 0.3s ease;
        }
        
        .message-input:focus {
            border-color: #6B46C1;
            box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1);
        }
        
        .send-button {
            background: linear-gradient(135deg, #00FF88 0%, #00CC6A 100%);
            color: #000000;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(0, 255, 136, 0.3);
        }
        
        .send-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.5);
        }
        
        .send-button:disabled {
            background: #3a3a3c;
            color: #8e8e93;
            cursor: not-allowed;
        }
        
        .header {
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(107, 70, 193, 0.2);
        }
        
        .ai-avatar {
            background: linear-gradient(135deg, #6B46C1 0%, #8B5CF6 100%);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 12px rgba(107, 70, 193, 0.3);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00FF88;
            position: absolute;
            bottom: 2px;
            right: 2px;
            border: 2px solid #000000;
        }
        
        .glass-effect {
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .scroll-smooth {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(28, 28, 30, 0.5);
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #6B46C1;
            border-radius: 2px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #8B5CF6;
        }
    </style>
</head>
<body class="bg-black text-white overflow-hidden">
    <div class="chat-container flex flex-col h-screen">
        <!-- Header -->
        <div class="header px-4 py-3 flex items-center justify-between sticky top-0 z-10">
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <div class="ai-avatar">
                        <i class="fas fa-robot text-lg"></i>
                    </div>
                    <div class="status-indicator"></div>
                </div>
                <div>
                    <h1 class="text-lg font-semibold text-white">Entrevistador IA</h1>
                    <p class="text-sm text-gray-400">Experto en ventas consultivas</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-400">En línea</div>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="chat-messages flex-1 overflow-y-auto px-4 py-4 space-y-4 scroll-smooth" id="messagesContainer">
            <!-- Messages will be added here dynamically -->
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator mx-4 hidden" id="typingIndicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span class="ml-2 text-sm text-gray-400">IA está escribiendo...</span>
        </div>

        <!-- Input Container -->
        <div class="input-container p-4 sticky bottom-0">
            <div class="flex items-end space-x-3">
                <div class="flex-1 relative">
                    <textarea 
                        id="messageInput"
                        class="message-input w-full px-4 py-3 pr-12 resize-none focus:outline-none placeholder-gray-500"
                        placeholder="Escribe tu respuesta..."
                        rows="1"
                        disabled
                    ></textarea>
                </div>
                <button 
                    id="sendButton"
                    class="send-button flex items-center justify-center focus:outline-none"
                    disabled
                >
                    <i class="fas fa-paper-plane text-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            WEBHOOK_URL: 'https://hook.us1.make.com/qpyb9g3fiwg9irysbmhc8fqr3r0rpqdy', // Cambiar por tu webhook
            USER_NAME: 'Carlos',
            TYPING_DELAY: 1500,
            INITIAL_MESSAGE: '¡Hola! Soy tu entrevistador virtual especializado en ventas consultivas. Me gustaría conocer más sobre una de tus experiencias de venta recientes para ayudarte a reflexionar y mejorar. ¿Podrías contarme sobre tu última venta? ¿Cómo fue esa experiencia?'
        };

        // DOM Elements
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');

        // Conversation state
        let conversationHistory = [];
        let isProcessing = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeChat();
            setupEventListeners();
        });

        function initializeChat() {
            // Add initial AI message
            setTimeout(() => {
                addMessage('ai', CONFIG.INITIAL_MESSAGE);
                enableInput();
            }, 1000);
        }

        function setupEventListeners() {
            // Send button click
            sendButton.addEventListener('click', handleSendMessage);
            
            // Enter key press
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        function handleSendMessage() {
            if (isProcessing) return;
            
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage('user', message);
            
            // Add to conversation history
            conversationHistory.push({
                respuesta: message
            });

            // Clear input and disable
            messageInput.value = '';
            messageInput.style.height = 'auto';
            disableInput();

            // Process with AI
            processWithAI(message);
        }

        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-bubble user-message px-4 py-3">
                        <p class="text-sm font-medium">${escapeHtml(content)}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <div class="ai-avatar flex-shrink-0">
                            <i class="fas fa-robot text-sm"></i>
                        </div>
                        <div class="message-bubble ai-message px-4 py-3">
                            <p class="text-sm leading-relaxed">${escapeHtml(content)}</p>
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            typingIndicator.classList.remove('hidden');
            scrollToBottom();
        }

        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
        }

        function enableInput() {
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
            isProcessing = false;
        }

        function disableInput() {
            messageInput.disabled = true;
            sendButton.disabled = true;
            isProcessing = true;
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function processWithAI(userMessage) {
            showTypingIndicator();
            
            try {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, CONFIG.TYPING_DELAY));
                
                // Prepare payload
                const payload = {
                    nombre: CONFIG.USER_NAME,
                    transcript: conversationHistory.map((item, index) => ({
                        pregunta: index === 0 ? CONFIG.INITIAL_MESSAGE : "Pregunta anterior",
                        respuesta: item.respuesta
                    })),
                    ultima_respuesta: userMessage
                };

                // Call webhook
                const response = await fetch(CONFIG.WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.next_question || data.response || "Gracias por compartir tu experiencia. ¿Hay algo más que te gustaría reflexionar sobre esta venta?";
                
                hideTypingIndicator();
                addMessage('ai', aiResponse);
                enableInput();
                
            } catch (error) {
                console.error('Error processing with AI:', error);
                hideTypingIndicator();
                
                // Fallback response
                const fallbackResponses = [
                    "Interesante perspectiva. ¿Podrías profundizar un poco más en ese aspecto?",
                    "Me gustaría conocer más detalles sobre eso. ¿Qué específicamente te llamó la atención?",
                    "¿Cómo crees que podrías aplicar esa experiencia en futuras ventas?",
                    "¿Qué aprendizaje específico te llevaste de esa situación?",
                    "¿Hubo algún momento particular donde sentiste que las cosas cambiaron en la venta?"
                ];
                
                const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                addMessage('ai', randomResponse);
                enableInput();
            }
        }

        // Add smooth scrolling behavior
        document.documentElement.style.scrollBehavior = 'smooth';
    </script>
</body>
</html>
